@page "/"
@rendermode InteractiveServer
@using RaftLibrary

<PageTitle>Home</PageTitle>

<div class="row">
    <div class="col">
        <div>

            <label for="speed">
                Election timeout between @(FormatMilliSeconds(150 * scalar)) and @(FormatMilliSeconds(300 *
                scalar)) seconds


                <input type="range" id="speed" name="speed" min="1" max="150" @bind:event="oninput"
                @bind=scalar @onchange=Update />

            </label>
        </div>
        <div>

            <label for="NetworkRequestDelay">
                Network Delay @FormatMilliSeconds(networkDelay) seconds
                <input type="range" id="NetworkRequestDelay" name="NetworkRequestDelay" min="10" max="10000"
                @bind:event="oninput" @bind=networkDelay @onchange=Update />
            </label>
        </div>
    </div>
</div>
<button @onclick="startSimulation">Start</button>

<div class="row">
    @foreach (var node in nodes)
    {
        var timeRemaining = node.InnerNode.TimerElapsed() / node.InnerNode.Timer.Interval;
        <div class="p-3 col-4">
            <div class="border p-3 rounded-3">
                <div class="d-flex justify-content-between">
                    <h3>
                        Node @node.Id
                    </h3>
                </div>
                <div class="@StateClass(node)">
                    @node.State
                </div>
                <div class="@TermClass(node)">
                    Term @node.Term
                </div>
                <div>
                    Leader is @node.LeaderID
                </div>
                <div>
                    Home Delay @networkDelay
                </div>
                <div>
                    Sim Delay?: @node.NetworkDelay
                </div>
                <div>
                    Interval?: @node.InnerNode.Timer.Interval
                </div>
                <div>
                    Votes: @string.Join(", ", node.InnerNode.Votes)
                </div>
                <div>
                    <div class="progress" role="progressbar" aria-label="Basic example"
                    aria-valuenow=@(Math.Abs(node.InnerNode.TimerElapsed())) aria-valuemin="0"
                    aria-valuemax="@(node.InnerNode.Timer.Interval)">
                        <div class="progress-bar bg-dark-subtle" style="width: @(timeRemaining * 1000)%;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>


@code {
    bool isRunning = false;
    private int scalar = 25;
    private int minInterval = 150;
    private int maxInterval = 301;
    private int networkDelay = 0;
    private Timer? timer;
    List<SimulationNode>? nodes = [];

    void startSimulation()
    {
        var node1 = new Node([], minInterval * scalar, maxInterval * scalar, ((maxInterval * scalar) / 3));
        var node2 = new Node([], minInterval * scalar, maxInterval * scalar, ((maxInterval * scalar) / 3));
        var node3 = new Node([], minInterval * scalar, maxInterval * scalar, ((maxInterval * scalar) / 3));

        var simulation1 = new SimulationNode(node1, networkDelay);
        var simulation2 = new SimulationNode(node2, networkDelay);
        var simulation3 = new SimulationNode(node3, networkDelay);

        node1.Nodes = [simulation2, simulation3];
        node2.Nodes = [simulation1, simulation3];
        node3.Nodes = [simulation2, simulation1];

        nodes = [simulation1, simulation2, simulation3];

        isRunning = true;

        timer = new Timer(_ =>
        {
            foreach (var node in nodes)
            {
                node.InnerNode.TimerElapsed();
            }
            InvokeAsync(StateHasChanged);
        }, null, 0, 50); 
    }

    public void Update()
    {
        foreach(var node in nodes)
        {
            node.NetworkDelay = networkDelay;
            node.InnerNode.MinInterval = minInterval * scalar;
            node.InnerNode.MaxInterval = maxInterval * scalar;
            node.InnerNode.LeaderInterval = ((maxInterval * scalar) / 3);
        }
    }


    string TermClass(SimulationNode node)
    {
        var maxTerm = nodes.Select(n => n.Term).Max();
        return "";
    }

    string StateClass(SimulationNode node)
    {
        if (node.State == NodeState.Leader)
            return "text-danger";
        if (node.State == NodeState.Candidate)
            return "text-warning";
        if (node.State == NodeState.Follower)
            return "text-success";
        return "";
    }

    public static string FormatTimeSpan(TimeSpan timeSpan)
    {
        double totalSeconds = timeSpan.TotalSeconds;
        return $"{totalSeconds:F1}";
    }

    public static string FormatMilliSeconds(double milliSeconds)
    {
        return $"{milliSeconds / 1000.0:F1}";
    }
}